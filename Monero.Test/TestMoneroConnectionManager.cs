using Monero.Common;
using Monero.Test.Utils;
using Monero.Wallet;
using Xunit.Sdk;

namespace Monero.Test;

public class TestMoneroConnectionManager
{

    public TestMoneroConnectionManager() { }

    [Fact]
    public void TestConnectionManager()
    {
        List<MoneroWalletRpc> walletRpcs = [];
        MoneroConnectionManager? connectionManager = null;
        Exception? ex = null;
        try
        {
            // start monero-wallet-rpc instances as test server connections (can also use monerod servers)
            for (int i = 0; i < 5; i++) walletRpcs.Add(TestUtils.StartWalletRpcProcess());

            // create connection manager
            connectionManager = new MoneroConnectionManager();

            // listen for changes
            ConnectionChangeCollector listener = new();
            connectionManager.AddListener(listener);

            // add prioritized connections
            connectionManager.AddConnection(walletRpcs[4].GetRpcConnection().SetPriority(1));
            connectionManager.AddConnection(walletRpcs[2].GetRpcConnection().SetPriority(2));
            connectionManager.AddConnection(walletRpcs[3].GetRpcConnection().SetPriority(2));
            connectionManager.AddConnection(walletRpcs[0].GetRpcConnection()); // default priority is lowest
            connectionManager.AddConnection(
                new MoneroRpcConnection(walletRpcs[1].GetRpcConnection().GetUri())); // test unauthenticated

            // test connections and order
            List<MoneroRpcConnection> orderedConnections = connectionManager.GetRpcConnections();
            Assert.True(orderedConnections[0] == walletRpcs[4].GetRpcConnection());
            Assert.True(orderedConnections[1] == walletRpcs[2].GetRpcConnection());
            Assert.True(orderedConnections[2] == walletRpcs[3].GetRpcConnection());
            Assert.True(orderedConnections[3] == walletRpcs[0].GetRpcConnection());
            Assert.True(orderedConnections[4].GetUri() == walletRpcs[1].GetRpcConnection().GetUri());
            foreach (MoneroRpcConnection c in orderedConnections) Assert.Null(c.IsOnline());

            // test getting connection by uri
            Assert.True(connectionManager.HasConnection(walletRpcs[0].GetRpcConnection().GetUri()));
            Assert.True(connectionManager.GetConnection(walletRpcs[0].GetRpcConnection().GetUri()) ==
                        walletRpcs[0].GetRpcConnection());

            // test unknown connection
            int numExpectedChanges = 0;
            connectionManager.SetConnection(orderedConnections[0]);
            Assert.Null(connectionManager.IsConnected());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);

            // auto connect to best available connection
            connectionManager.StartPolling((ulong)TestUtils.SYNC_PERIOD_IN_MS);
            Thread.Sleep(TestUtils.AUTO_CONNECT_TIMEOUT_MS);
            Assert.True(connectionManager.IsConnected());
            MoneroRpcConnection? connection = connectionManager.GetConnection();
            Assert.True(connection.IsOnline() == true);
            // TODO manager doesn't seem to check all connections in time
            Assert.True(connection == walletRpcs[4].GetRpcConnection());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] == connection);
            connectionManager.SetAutoSwitch(false);
            connectionManager.StopPolling();
            connectionManager.Disconnect();
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] == null);

            // start periodically checking connection without auto switch
            connectionManager.StartPolling((ulong)TestUtils.SYNC_PERIOD_IN_MS, false, null, null, null);

            // connect to best available connection in order of priority and response time
            connection = connectionManager.GetBestAvailableConnection();
            connectionManager.SetConnection(connection);
            Assert.True(connection == walletRpcs[4].GetRpcConnection());
            Assert.True(connection.IsOnline());
            Assert.True(connection.IsAuthenticated());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] == connection);

            // test connections and order
            orderedConnections = connectionManager.GetRpcConnections();
            Assert.True(orderedConnections[0] == walletRpcs[4].GetRpcConnection());
            Assert.True(orderedConnections[1] == walletRpcs[2].GetRpcConnection());
            Assert.True(orderedConnections[2] == walletRpcs[3].GetRpcConnection());
            Assert.True(orderedConnections[3] == walletRpcs[0].GetRpcConnection());
            Assert.True(orderedConnections[4].GetUri() == walletRpcs[1].GetRpcConnection().GetUri());
            for (int i = 1; i < orderedConnections.Count; i++) Assert.Null(orderedConnections[i].IsOnline());

            // shut down prioritized servers
            TestUtils.StopWalletRpcProcess(walletRpcs[2]);
            TestUtils.StopWalletRpcProcess(walletRpcs[3]);
            TestUtils.StopWalletRpcProcess(walletRpcs[4]);
            GenUtils.WaitFor(TestUtils.SYNC_PERIOD_IN_MS + 100); // allow time to poll
            Assert.False(connectionManager.IsConnected());
            Assert.False(connectionManager.GetConnection().IsOnline());
            Assert.Null(connectionManager.GetConnection().IsAuthenticated());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] ==
                        connectionManager.GetConnection());

            // test connection order
            orderedConnections = connectionManager.GetRpcConnections();
            Assert.True(orderedConnections[0] == walletRpcs[4].GetRpcConnection());
            Assert.True(orderedConnections[1] == walletRpcs[0].GetRpcConnection());
            Assert.True(orderedConnections[2].GetUri() == walletRpcs[1].GetRpcConnection().GetUri());
            Assert.True(orderedConnections[3] == walletRpcs[2].GetRpcConnection());
            Assert.True(orderedConnections[4] == walletRpcs[3].GetRpcConnection());

            // check all connections
            connectionManager.CheckConnections();

            // test connection order
            orderedConnections = connectionManager.GetRpcConnections();
            Assert.True(orderedConnections[0] == walletRpcs[4].GetRpcConnection());
            Assert.True(orderedConnections[1] == walletRpcs[0].GetRpcConnection());
            Assert.True(orderedConnections[2].GetUri() == walletRpcs[1].GetRpcConnection().GetUri());
            Assert.True(orderedConnections[3] == walletRpcs[2].GetRpcConnection());
            Assert.True(orderedConnections[4] == walletRpcs[3].GetRpcConnection());

            // test online and authentication status
            for (int i = 0; i < orderedConnections.Count; i++)
            {
                bool? isOnline = orderedConnections[i].IsOnline();
                bool? isAuthenticated = orderedConnections[i].IsAuthenticated();
                if (i == 1 || i == 2) Assert.True(isOnline);
                else Assert.False(isOnline);
                if (i == 1) Assert.True(isAuthenticated);
                else if (i == 2) Assert.False(isAuthenticated);
                else Assert.Null(isAuthenticated);
            }

            // test auto switch when disconnected
            connectionManager.SetAutoSwitch(true);
            GenUtils.WaitFor(TestUtils.SYNC_PERIOD_IN_MS + 100);
            Assert.True(connectionManager.IsConnected());
            connection = connectionManager.GetConnection();
            Assert.NotNull(connection);
            Assert.True(connection.IsOnline());
            Assert.True(connection == walletRpcs[0].GetRpcConnection());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] == connection);

            // test connection order
            orderedConnections = connectionManager.GetRpcConnections();
            Assert.True(orderedConnections[0] == connection);
            Assert.True(orderedConnections[0] == walletRpcs[0].GetRpcConnection());
            Assert.True(orderedConnections[1].GetUri() == walletRpcs[1].GetRpcConnection().GetUri());
            Assert.True(orderedConnections[2] == walletRpcs[4].GetRpcConnection());
            Assert.True(orderedConnections[3] == walletRpcs[2].GetRpcConnection());
            Assert.True(orderedConnections[4] == walletRpcs[3].GetRpcConnection());

            // connect to specific endpoint without authentication
            connection = orderedConnections[1];
            Assert.False(connection.IsAuthenticated());
            connectionManager.SetConnection(connection);
            Assert.False(connectionManager.IsConnected());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);

            // connect to specific endpoint with authentication
            orderedConnections[1].SetCredentials("rpc_user", "abc123");
            connectionManager.CheckConnections();
            Assert.True(connectionManager.GetConnection().GetUri() == walletRpcs[1].GetRpcConnection().GetUri());
            Assert.True(connection.IsOnline());
            Assert.True(connection.IsAuthenticated());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] == connection);

            // test connection order
            orderedConnections = connectionManager.GetRpcConnections();
            Assert.True(orderedConnections[0] == connectionManager.GetConnection());
            Assert.True(orderedConnections[0].GetUri() == walletRpcs[1].GetRpcConnection().GetUri());
            Assert.True(orderedConnections[1] == walletRpcs[0].GetRpcConnection());
            Assert.True(orderedConnections[2] == walletRpcs[4].GetRpcConnection());
            Assert.True(orderedConnections[3] == walletRpcs[2].GetRpcConnection());
            Assert.True(orderedConnections[4] == walletRpcs[3].GetRpcConnection());
            for (int i = 0; i < orderedConnections.Count - 1; i++)
                Assert.True(
                    i <= 1 ? orderedConnections[i].IsOnline() == true : orderedConnections[i].IsOnline() != true);
            Assert.False(orderedConnections[4].IsOnline());

            // set connection to existing uri
            connectionManager.SetConnection(walletRpcs[0].GetRpcConnection().GetUri());
            Assert.True(connectionManager.IsConnected());
            Assert.True(walletRpcs[0].GetRpcConnection() == connectionManager.GetConnection());

            MoneroRpcConnection currentConnection = (MoneroRpcConnection)connectionManager.GetConnection();
            MoneroRpcConnection rpcConnection = new();

            if (rpcConnection.GetType().IsInstanceOfType(currentConnection))
            {
                rpcConnection = (MoneroRpcConnection)currentConnection;
                Assert.True(TestUtils.WALLET_RPC_USERNAME == rpcConnection.GetUsername());
                Assert.True(TestUtils.WALLET_RPC_PASSWORD == rpcConnection.GetPassword());
            }

            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] ==
                        walletRpcs[0].GetRpcConnection());

            // set connection to new uri
            connectionManager.StopPolling();
            string uri = "http://localhost:49999";
            connectionManager.SetConnection(uri);
            Assert.True(uri == connectionManager.GetConnection().GetUri());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(uri == listener.ChangedConnections[listener.ChangedConnections.Count - 1].GetUri());

            // set connection to empty string
            connectionManager.SetConnection("");
            Assert.Null(connectionManager.GetConnection());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);

            // check all connections and test auto switch
            connectionManager.CheckConnections();
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(connectionManager.IsConnected());

            // remove current connection and test auto switch
            connectionManager.RemoveConnection(connectionManager.GetConnection().GetUri());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.False(connectionManager.IsConnected());
            connectionManager.CheckConnections();
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(connectionManager.IsConnected());

            // test polling current connection
            connectionManager.SetConnection(null);
            Assert.False(connectionManager.IsConnected());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            connectionManager.StartPolling((ulong)TestUtils.SYNC_PERIOD_IN_MS, null, null,
                MoneroConnectionManager.PollType.CURRENT, null);
            Thread.Sleep(TestUtils.AUTO_CONNECT_TIMEOUT_MS);
            Assert.True(connectionManager.IsConnected());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);

            // test polling all connections
            connectionManager.SetConnection(null);
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            connectionManager.StartPolling((ulong)TestUtils.SYNC_PERIOD_IN_MS, null, null,
                MoneroConnectionManager.PollType.ALL, null);
            Thread.Sleep(TestUtils.AUTO_CONNECT_TIMEOUT_MS);
            Assert.True(connectionManager.IsConnected());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);

            // shut down all connections
            connection = connectionManager.GetConnection();
            foreach (MoneroWalletRpc walletRpc in walletRpcs) TestUtils.StopWalletRpcProcess(walletRpc);
            GenUtils.WaitFor(TestUtils.SYNC_PERIOD_IN_MS + 100);
            Assert.False(connection.IsOnline());
            Assert.True(++numExpectedChanges == listener.ChangedConnections.Count);
            Assert.True(listener.ChangedConnections[listener.ChangedConnections.Count - 1] == connection);

            // reset
            connectionManager.Reset();
            Assert.True(0 == connectionManager.GetConnections().Count);
            Assert.Null(connectionManager.GetConnection());
        }
        catch (Exception exception)
        {
            ex = exception;
        }
        finally
        {
            if (connectionManager != null)
            {
                connectionManager.Reset();
            }

            foreach (MoneroWalletRpc wallet in walletRpcs)
            {
                try
                {
                    TestUtils.StopWalletRpcProcess(wallet);
                }
                catch (Exception e)
                {
                    Console.WriteLine("An error occurred while stopping RPC wallet: " + e.Message);
                }
            }
        }
        
        if (ex != null) Assert.Fail($"An exception occurred: {ex.Message}, {ex.StackTrace}");
    }
}

internal class ConnectionChangeCollector : MoneroConnectionManagerListener
{
    public List<MoneroRpcConnection?> ChangedConnections = [];

    public void OnConnectionChanged(MoneroRpcConnection? connection)
    {
        ChangedConnections.Add(connection);
    }
}